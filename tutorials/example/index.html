<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/styles/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/pure.css"> <link rel=stylesheet  href="/css/side-menu.css"> <style> .franklin-content{padding-left:10%;} @media (min-width: 940px) { .franklin-content {width: 640px; margin-left: 0px; padding-left: 80px;} .header {width: 700px;} } </style> <link rel=icon  href="/assets/favicon.png"> <title>EarthSciML Example</title> <div id=layout > <a href="#menu" id=menuLink  class=menu-link ><span></span></a> <div id=menu > <div class=pure-menu > <a class=pure-menu-heading  href="#">EarthSciML</a> <ul class=pure-menu-list > <li class="pure-menu-item "><a href="/" class=pure-menu-link >Home</a> <li class="pure-menu-item "><a href="/tutorials/getting_started/" class=pure-menu-link >Getting Started</a> <li class="pure-menu-item pure-menu-selected"><a href="/tutorials/example/" class=pure-menu-link >Example</a> <li class="pure-menu-item "><a href="/contributing/" class=pure-menu-link >Contributing</a> </ul> </div> </div> <div id=main > <div class=header > <h1>EarthSciML Example</h1> <h2></h2> </div> <div class=franklin-content > <h1 id=example ><a href="#example" class=header-anchor >Example</a></h1> <div class=franklin-toc ><ol><li><a href="#figure_1">Figure 1</a><li><a href="#figure_2">Figure 2</a><li><a href="#supplemental_plotting_code">Supplemental plotting code</a><li><a href="#figure_3">Figure 3</a><li><a href="#supplemental_code_to_skip_unit_enforcement">Supplemental code to skip unit enforcement</a><li><a href="#figure_4">Figure 4</a><li><a href="#supplemental_plotting_code__2">Supplemental plotting code</a></ol></div> <h2 id=figure_1 ><a href="#figure_1" class=header-anchor >Figure 1</a></h2> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> EarthSciData, EarthSciMLBase, GasChem,
    DomainSets, ModelingToolkit, MethodOfLines, 
    DifferentialEquations, Dates, Distributions,
    Latexify, Plots

<span class=hljs-meta >@parameters</span> t lev lon lat
model = SuperFast(t)
latexify(model.rxn_sys)</code></pre> <h2 id=figure_2 ><a href="#figure_2" class=header-anchor >Figure 2</a></h2> <pre><code class="julia hljs">start, finish = Dates.datetime2unix.([
    Dates.DateTime(<span class=hljs-number >2022</span>, <span class=hljs-number >5</span>, <span class=hljs-number >1</span>),
    Dates.DateTime(<span class=hljs-number >2022</span>, <span class=hljs-number >5</span>, <span class=hljs-number >3</span>),
])
model_ode = SuperFast(t) + FastJX(t)
prob = ODEProblem(structural_simplify(get_mtk(model_ode)), [], (start, finish), [])
sol = solve(prob, TRBDF2(), saveat=<span class=hljs-number >1800.0</span>)
plot(sol, ylims=(<span class=hljs-number >0</span>,<span class=hljs-number >15</span>))</code></pre> <h2 id=supplemental_plotting_code ><a href="#supplemental_plotting_code" class=header-anchor >Supplemental plotting code</a></h2> <pre><code class="julia hljs">ticks = Dates.datetime2unix.([Dates.DateTime(<span class=hljs-number >2022</span>, <span class=hljs-number >5</span>, <span class=hljs-number >1</span>), Dates.DateTime(<span class=hljs-number >2022</span>, <span class=hljs-number >5</span>, <span class=hljs-number >2</span>), Dates.DateTime(<span class=hljs-number >2022</span>, <span class=hljs-number >5</span>, <span class=hljs-number >3</span>)])
tickstrings = Dates.format.(Dates.unix2datetime.(ticks), <span class=hljs-string >&quot;m-d-yy&quot;</span>)
plot(sol,ylims=(<span class=hljs-number >0</span>,<span class=hljs-number >15</span>),xlabel=<span class=hljs-string >&quot;Date&quot;</span>, ylabel=<span class=hljs-string >&quot;Concentration (ppb)&quot;</span>, ylabelfontsize=<span class=hljs-number >9</span>, xlabelfontsize=<span class=hljs-number >9</span>, 
    xticks=(ticks, tickstrings), legend=:outertopright, size=(<span class=hljs-number >500</span>, <span class=hljs-number >310</span>))
savefig(joinpath(<span class=hljs-meta >@__DIR__</span>, <span class=hljs-string >&quot;../latex/figures/ode.pdf&quot;</span>))</code></pre> <h2 id=figure_3 ><a href="#figure_3" class=header-anchor >Figure 3</a></h2> <pre><code class="julia hljs"><span class=hljs-keyword >struct</span> Emissions &lt;: EarthSciMLODESystem
    sys
    <span class=hljs-keyword >function</span> Emissions(t, μ_lon, σ)
        <span class=hljs-meta >@variables</span> NO(t) ISOP(t)
        dist = MvNormal([start,μ_lon],[<span class=hljs-number >3600.0</span>,σ])
        <span class=hljs-meta >@parameters</span> lon
        D = Differential(t)
        new(ODESystem([
            D(NO) ~ pdf(dist, [t, lon]) * <span class=hljs-number >50</span>, 
            D(ISOP) ~ pdf(dist, [t, lon]) * <span class=hljs-number >50</span>,
        ], t, name=:emissions))
    <span class=hljs-keyword >end</span>
<span class=hljs-keyword >end</span>
Base.:(+)(e::Emissions, b::SuperFast) = operator_compose(b, e)
Base.:(+)(b::SuperFast, e::Emissions) = e + b</code></pre> <h2 id=supplemental_code_to_skip_unit_enforcement ><a href="#supplemental_code_to_skip_unit_enforcement" class=header-anchor >Supplemental code to skip unit enforcement</a></h2> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> ModelingToolkit.check_units(eqs...) <span class=hljs-comment ># Skip unit enforcement for now</span>
    ModelingToolkit.validate(eqs...) || <span class=hljs-meta >@info</span> <span class=hljs-string >&quot;Some equations had invalid units. See warnings for details.&quot;</span>
<span class=hljs-keyword >end</span></code></pre> <h2 id=figure_4 ><a href="#figure_4" class=header-anchor >Figure 4</a></h2> <pre><code class="julia hljs">julia
domain = DomainInfo(
    partialderivatives_lonlat2xymeters,
    constIC(<span class=hljs-number >1.0f0</span>, t ∈ Interval(start, finish)),
    zerogradBC(lon ∈ Interval(-<span class=hljs-number >130f0</span>, -<span class=hljs-number >100f0</span>)))

geos = GEOSFP(<span class=hljs-string >&quot;0.25x0.3125_NA&quot;</span>, t; coord_defaults = <span class=hljs-built_in >Dict</span>(:lat =&gt; <span class=hljs-number >34.0</span>, :lev =&gt; <span class=hljs-number >1</span>))

model = SuperFast(t) + FastJX(t) + domain +
    Emissions(t, -<span class=hljs-number >118.2</span>, <span class=hljs-number >0.2</span>)+ Advection() + geos

discretization = MOLFiniteDifference([lon =&gt; <span class=hljs-number >50</span>], t, approx_order=<span class=hljs-number >2</span>)
prob = discretize(get_mtk(model), discretization)
sol = solve(prob, TRBDF2(), saveat=<span class=hljs-number >3600.0</span>)</code></pre> <h2 id=supplemental_plotting_code__2 ><a href="#supplemental_plotting_code__2" class=header-anchor >Supplemental plotting code</a></h2> <pre><code class="julia hljs">discrete_lon = sol[lon]
discrete_t = sol[t]

<span class=hljs-meta >@variables</span> superfast₊O3(..) superfast₊NO(..) superfast₊ISOP(..) superfast₊NO2(..)
sol_isop = sol[superfast₊ISOP(t, lon)]
sol_o3 = sol[superfast₊O3(t, lon)]
sol_no = sol[superfast₊NO(t, lon)]
sol_no2 = sol[superfast₊NO2(t, lon)]

<span class=hljs-keyword >using</span> LaTeXStrings
plot(
    heatmap(discrete_t, discrete_lon[<span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>], sol_isop[:, <span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>]&#x27;, 
        xticks=(ticks, tickstrings), 
        ylabel=<span class=hljs-string >&quot;Longitude (°)&quot;</span>, title=<span class=hljs-string >&quot;Isoprene&quot;</span>, titlefontsize=<span class=hljs-number >12</span>,
        margin=<span class=hljs-number >0</span>Plots.mm,
        size=(<span class=hljs-number >600</span>, <span class=hljs-number >400</span>), dpi=<span class=hljs-number >300</span>),
    heatmap(discrete_t, discrete_lon[<span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>], sol_no[:, <span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>]&#x27;, 
        xticks=(ticks, tickstrings), title=<span class=hljs-string >&quot;NO&quot;</span>, titlefontsize=<span class=hljs-number >12</span>),
    heatmap(discrete_t, discrete_lon[<span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>], sol_no2[:, <span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>]&#x27;, 
        xticks=(ticks, tickstrings), xlabel=<span class=hljs-string >&quot;Date&quot;</span>, title=<span class=hljs-string >L&quot;\textrm{NO_2}&quot;</span>),
    heatmap(discrete_t, discrete_lon[<span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>], sol_o3[:, <span class=hljs-number >1</span>:<span class=hljs-keyword >end</span>]&#x27;,colorbar_title=<span class=hljs-string >&quot;Concentration (ppb)&quot;</span>,
        xticks=(ticks, tickstrings), title=<span class=hljs-string >L&quot;\textrm{O_3}&quot;</span>, titlefontsize=<span class=hljs-number >12</span>),
)
savefig(joinpath(<span class=hljs-meta >@__DIR__</span>, <span class=hljs-string >&quot;../latex/figures/pde.png&quot;</span>))</code></pre> <div class=page-foot > <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> EarthSciML Authors and Contributors. Last modified: May 05, 2023. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div> </div> <script src="/libs/pure/ui.min.js"></script> <script src="/libs/highlight/highlight.min.js"></script> <script>hljs.highlightAll();hljs.configure({tabReplace: ' '});</script>